function validateEmail(e){var t=/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}/gim;return t.test(e)?!0:!1}function validateName(e){var t=/^[a-zA-Z\.\'\s\-]+$/;return t.test(e)?!0:!1}function validate(e,t){var s=!0;return $(".err").remove(),0==e.length&&($("#userName").after('<div class="err" id="err1">Required field</div>'),$("#err1").slideDown("slow"),s=!1),e.length>100&&($("#userName").after('<div class="err" id="err3">Max length is 100</div>'),$("#err3").slideDown("slow"),s=!1),e.length>0&&!validateName(e)&&($("#userName").after('<div class="err" id="err4">Letters, fullstops and _ only</div>'),$("#err4").slideDown("slow"),s=!1),validateEmail(t)||($("#userEmail").after('<div class="err" id="err2">Valid email required</div>'),$("#err2").slideDown("slow"),s=!1),s}function setChristmasGameCookie(e,t){var s=new Date;s.setTime(s.getTime()+31536e6);var a="expires="+s.toUTCString();document.cookie="christmasGameUser="+e+","+t+";"+a}function getChristmasGameCookie(){for(var e=document.cookie.split(";"),t=!1,s=0;s<e.length;s++){var a=e[s].split("=");if("christmasGameUser"==a[0]||" christmasGameUser"==a[0]){var i=a[1].split(",");2==i.length&&validateName(i[0])&&validateEmail(i[1])&&(t=i)}}return t}function loadLevel(e){finished=!1,attemptsCount=0,e>0&&lastLevel>=e?($("#splashbackground").hide(),$("#loadingImage").show(),1===e?$("#game").load("templates/gameVisual.php",function(e,t){$messageDisplayBox=$("#message"),$("#loadingImage").hide(),"error"==t?$messageDisplayBox.html(genericError):(resetClock(),$startSafeZone=$("#startArea"),$gameBoxDiv=$("#mazeContainer"),$gameBoxDiv.on("contextmenu",function(){return!1}),$finishBox=$("#finishArea"),$gameDiv=$("#game"),$messageDisplayBox.html(smallInstructions),$presentOne=$("#present_1_single"),$road=$("#road"),$shifty=$(".shifty"),$startSafeZone.click(function(){playing||finished||startLevel()}),$gameBoxDiv.on("mouseover mouseout",".boundary",function(){playing&&gameDeath()}),$("#checkpoint").mouseover(function(){checkpointPassed=!0}),$finishBox.mouseover(function(){playing&&finishLevel()})),$messageDisplayBox.html(smallInstructions),$(".open").click(function(){bigInstruct()})}):$gameBoxDiv.load("templates/level"+e+".php",function(e,t){"error"==t&&$messageDisplayBox.html(genericError),attemptsCount=0,resetClock()})):quitGame()}function startLevel(){resetClock(),resetPresents(),startClock(),$messageDisplayBox.html(smallInstructions),playing=!0,$gameBoxDiv.css({cursor:'url("img/cursor.gif"), auto'}),$("#tally").text(++attemptsCount)}function finishLevel(){checkpointPassed?(stopClock(),playing=!1,finished=!0,$.post("api/index.php",{action:"saveLevel",level:levelNumber,attempts:attemptsCount,time:ticks},function(e){"success"in e&&e.success?levelNumber===lastLevel?$("#message").html('<div class="message bigMessage"><div class="messageContent1"><h2>Congratulations!</h2> <h4>You finished the game in: '+seconds2time(ticks)+"</h4><h4>and it took you a total of "+attemptsCount+' attempts!</h4><h4>Your results have been submitted</h4><div class="buttonBigMessage"><input type="button" value="Play Again!" class="messageButton replay"> </div></div></div>').animate({width:"690px",height:"360px"},function(){$(".replay").click(function(){quitGame()}),$(".messageContent").fadeIn(500)}):loadLevel(++levelNumber):$messageDisplayBox.html(genericError)},"json").fail(function(){$messageDisplayBox.html(genericError)})):gameDeath()}function gameDeath(){stopClock(),$gameBoxDiv.css("cursor","not-allowed"),playing=!1,$messageDisplayBox.html('<div class="message"><h4>Uh-oh, you touched the sides!</h4><h5>Click <span>start</span> to try again</h5><div class="button"><input type="button" value="How To Play" class="messageButton open"></div></div>'),$(".open").click(function(){bigInstruct()}),$(".quit").click(function(){quitGame()})}function bigInstruct(){$("#message").html(bigInstructions).animate({width:"690px",height:"360px"},function(){$(".hide").click(function(){smallInstruct()}),$(".messageContent").fadeIn(500)})}function smallInstruct(){$(".messageContent").fadeOut(500,function(){$("#message").html(bigInstructions).animate({width:"215px",height:"160px"},function(){$("#message").html(smallInstructions),$(".open").click(function(){bigInstruct()})})})}function quitGame(){window.location.reload(!1)}function seconds2time(e){var t=Math.floor(e/3600),s=Math.floor((e-3600*t)/60),e=e-3600*t-60*s,a="";return 0!=t&&(a=t+":"),s=10>s?"0"+s:String(s),a+=s+":",a+=10>e?"0"+e:String(e)}function startClock(){clock=setInterval(function(){animatePresents(),document.getElementById("seconds").innerHTML=seconds2time(++ticks)},1e3)}function stopClock(){clearInterval(clock)}function resetClock(){clearInterval(clock),ticks=0,document.getElementById("seconds").innerHTML="00:00"}function animatePresents(){0==ticks||ticks%2==0?($presentOne.animate({left:"-=26"},1e3,"linear"),$shifty.animate({left:"+=6"},1e3,"linear")):($presentOne.animate({left:"+=26"},1e3,"linear"),$shifty.animate({left:"-=6"},1e3,"linear"))}function resetPresents(){$presentOne.attr("style",""),$shifty.attr("style","")}$(function(){var e=getChristmasGameCookie();e&&($("#form").prepend("<p id='welcomeBack'>Welcome back!</p>"),$("#userName").val(e[0]),$("#userEmail").val(e[1])),$("form").submit(function(e){e.preventDefault();var t=$("#userName").val(),s=$("#userEmail").val();validate(t,s)&&$.post("api/index.php",{action:"createUser",userName:t,userEmail:s},function(e){"success"in e&&e.success?(setChristmasGameCookie(t,s),$("#game").addClass("level1"),loadLevel(1)):$("#form").after("<div id='connectionError'>Error: Please refresh the page and try again.</div>")},"json").fail(function(){$messageDisplayBox.replaceWith("Error: There appears to be a problem!")})})});var genericError='<div class="message"><h4>Oops!</h4><h5>Please try reloading the page</h5></div>',smallInstructions='<div class="message"><div><input type="button" value="How To Play" class="messageButton centre open"></div></div>',bigInstructions='<div class="message bigMessage"><div class="messageContent"><h2>How To Play</h2><h4>Follow the path with your mouse cursor to make it down the first chimney, through the office and up out of the second chimney as quickly and with as few attempts as possible, avoiding touching the sides and looking out for obstacles.</h4><h4>Close the instructions then click <span>Start</span> to begin!</h4><input type="button" value="Close" class="messageButton hide"> </div></div>',lastLevel=1,playing=!1,finished,checkpointPassed=!1,$startSafeZone,levelNumber=1,$gameDiv,$gameBoxDiv,$messageDisplayBox,$finishBox,attemptsCount=0,ticks=0,clock;